#!/usr/bin/env zsh

heading "Refreshing setup repository"

_setup_repo_detect_root() {
  if [[ -n "${SETUP_REPO_ROOT:-}" && -d "${SETUP_REPO_ROOT}/.git" ]]; then
    printf '%s' "${SETUP_REPO_ROOT}"
    return 0
  fi

  local script_path
  script_path="${(%):-%N}"
  if [[ -z "${script_path}" ]]; then
    return 1
  fi

  local script_dir
  script_dir="${script_path:A:h}"
  local candidate
  candidate="${script_dir%/scripts}"
  if [[ -d "${candidate}/.git" ]]; then
    printf '%s' "${candidate}"
    return 0
  fi

  return 1
}

_refresh_setup_repo() {
  local repo_root
  repo_root=$(_setup_repo_detect_root 2>/dev/null || true)
  if [[ -z "${repo_root}" ]]; then
    echo "Unable to determine repository root. Skipping automatic refresh." >&2
    return 0
  fi

  if ! command -v git >/dev/null 2>&1; then
    echo "git is not available. Skipping automatic refresh." >&2
    return 0
  fi

  (
    set -e
    cd "${repo_root}" || exit 0
    if git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
      git fetch --quiet --all || echo "git fetch failed" >&2
      if ! git pull --quiet --ff-only; then
        git pull --quiet || echo "git pull failed" >&2
      fi
    fi

    if [[ -x "./build.sh" ]]; then
      ./build.sh >/dev/null 2>&1 || ./build.sh
    fi
  ) || true
}

_refresh_setup_repo
unset -f _refresh_setup_repo _setup_repo_detect_root
